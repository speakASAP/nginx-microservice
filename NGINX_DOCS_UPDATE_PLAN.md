## Goal

Ensure **all nginx-microservice documentation** consistently describes the **validated nginx config workflow**:

> Generate Config → Write to `conf.d/staging/` → Validate in Isolation → If Valid: Move to `conf.d/blue-green/` → Create Symlink in `conf.d/` → Safe Reload Nginx  
>                                           → If Invalid: Move to `conf.d/rejected/` and Keep Nginx Running with Existing Valid Configs

and remove any remaining references to the legacy “write directly to `conf.d/*.conf` and reload nginx” process.

---

## Files to Update

1. `docs/NGINX MICROSERVICE.md` (primary, currently legacy)
2. `docs/BLUE_GREEN_DEPLOYMENT.md` (script names + explicit validation mention)
3. `docs/BLUE_GREEN_TROUBLESHOOTING.md` (script names + add-domain behavior notes)

---

## Detailed Plan by File

### 1. `docs/NGINX MICROSERVICE.md`

**Objective:** Modernize this older implementation-plan document so it:
- Matches the current **staging + validation + blue-green + symlink** system.
- Clearly states that **invalid configs can’t break nginx**.
- Removes instructions describing direct editing or direct creation of `nginx/conf.d/*.conf` as active configs.

**Planned Changes:**

1. **Key Principles section**
   - Keep bullets about host-first storage, DNS-based discovery, certificate management, and automation.
   - Add a bullet explicitly stating:
     - “**Validated Config Pipeline**: All nginx configs are generated to a staging directory, validated in isolation with existing configs, and only then applied via blue/green configs and symlinks. Invalid configs are rejected and never break nginx.”

2. **Project Structure section**
   - Update the `nginx/` tree to reflect the current layout:
     - Under `nginx/`:
       - Show:
         - `conf.d/`
           - `staging/`
           - `blue-green/`
           - `rejected/`
           - `{domain}.conf` (symlink to `blue-green/{domain}.{color}.conf`)
         - `templates/`
           - `domain.conf.template`
           - `domain-blue-green.conf.template`
     - Remove or update any lines that imply `nginx/conf.d/statex.cz.conf` or `crypto-ai-agent.statex.cz.conf` are manually maintained “real” configs rather than symlinks.

3. **Implementation Checklist section**
   - Leave historical checklist items, but:
     - Optionally add a short note near the nginx config items that:
       - “Config files are now generated and managed by the blue/green validation system; manual creation of raw `conf.d/*.conf` files is replaced by the validated pipeline.”

4. **Add Domain Process section**
   - Replace the legacy 8-step flow with a **new 8–10 step flow** that explicitly follows:
     1. Run `./scripts/add-domain.sh <domain> <container-name> [port] [email]`.
     2. Script validates inputs.
     3. Script generates an nginx config from `nginx/templates/domain.conf.template` into `nginx/conf.d/staging/{domain}.blue.conf`.
     4. Script uses the **central validation system** to test the new config in isolation together with all existing validated configs.
     5. If validation **fails**:
        - Config is moved to `nginx/conf.d/rejected/{domain}.blue.conf.<timestamp>`.
        - Nginx continues running with existing `blue-green` configs.
        - Script exits non-zero and prints instructions for inspecting the rejected file and logs.
     6. If validation **passes**:
        - Config is moved to `nginx/conf.d/blue-green/{domain}.blue.conf`.
        - Symlink `nginx/conf.d/{domain}.conf` is created/updated to point to `blue-green/{domain}.blue.conf`.
     7. Script checks/requests SSL certificates as before.
     8. Script triggers a **safe reload** via `reload_nginx`, which:
        - Tests configuration using a tolerant helper.
        - Starts nginx if it is not running.
        - Reloads configs while preserving existing connections.
     9. Script verifies container accessibility (informational only).
   - Explicitly state in this section:
     - “**Safety guarantee**: A bad config generated by `add-domain.sh` is always rejected into `nginx/conf.d/rejected/` and cannot break a running nginx instance.”

5. **Maintenance section**
   - Update bullets:
     - “Add new domain: `./scripts/add-domain.sh domain.com container port` – uses the validated staging + blue/green + symlink pipeline; invalid configs are rejected.”
     - “Remove domain: `./scripts/remove-domain.sh domain.com` – removes the symlink and validated config; nginx is re-tested and reloaded safely.”
     - “List domains: `./scripts/list-domains.sh` – reads current `conf.d/*.conf` symlinks and associated certificates.”
     - “Reload nginx: `./scripts/reload-nginx.sh` – uses a tolerant reload that assumes configs were already validated.”
   - Ensure there are **no** remaining phrases suggesting:
     - Manually editing `nginx/conf.d/*.conf` to add services.
     - Directly running `nginx -t`/`nginx -s reload` without going through the helper scripts.

6. **Optional: New “Nginx Config Validation Workflow” subsection**
   - Add a short subsection, reusing the canonical text (consistent with README and `CONTAINER_NGINX_SYNC.md`):
     - Describe the directory structure (`staging`, `blue-green`, `rejected`, symlink).
     - Describe the validation flow (1–4 bullet points).
     - Emphasize:
       - **Nginx always runs independently of container state.**
       - **Invalid configs are rejected without affecting existing services.**

---

### 2. `docs/BLUE_GREEN_DEPLOYMENT.md`

**Objective:** Ensure this doc references the **current scripts** and explicitly acknowledges that nginx configs are created via the validated staging → blue-green pipeline.

**Planned Changes:**

1. **Update script names**
   - Replace references to:
     - `./scripts/blue-green/deploy.sh` → `./scripts/blue-green/deploy-smart.sh`
     - `./scripts/blue-green/prepare-green.sh` → `./scripts/blue-green/prepare-green-smart.sh`
   - Update:
     - “Available Scripts” section.
     - “Standard Deployment Flow” diagram text.
     - All example commands in troubleshooting and advanced usage.

2. **Clarify configuration generation**
   - In “Configuration Generation” / “Nginx Configuration” sections, add explicit text that:
     - Blue/green configs are **generated into `nginx/conf.d/staging/`**.
     - Each config is validated in isolation using the central `utils.sh` helpers.
     - Only validated configs are moved into `nginx/conf.d/blue-green/`.
     - Rejected configs go into `nginx/conf.d/rejected/` and **do not affect nginx**.
   - Where it describes:
     - “Configs are auto-generated from the service registry using the template system”, extend this with:
       - “Generation always runs through the validation pipeline described in `IMPLEMENTATION_PLAN_VALIDATION.md` and `NGINX_VALIDATION_ENFORCEMENT_PLAN.md`.”

3. **Standard Deployment Flow diagram**
   - In the textual flow:
     - At the step where configs are (implicitly) created or used, add a sub-bullet:
       - “Nginx configs for the service are generated to `staging/`, validated in isolation, and then applied to `blue-green/` with `{domain}.conf` symlink.”
   - Ensure wording never implies manually editing `conf.d/*.conf`.

4. **“Adding a New Service” subsection**
   - In the steps:
     - Keep registry/state/docker-compose steps.
     - For:
       - “Run migration to generate blue/green configs: `./scripts/blue-green/migrate-to-symlinks.sh {service-name}`”
     - Add note:
       - “This migration uses the same staging + validation + blue/green pipeline; invalid configs are rejected into `rejected/`.”

---

### 3. `docs/BLUE_GREEN_TROUBLESHOOTING.md`

**Objective:** Align troubleshooting examples with the validated pipeline and current blue/green scripts.

**Planned Changes:**

1. **Update script names**
   - Replace all mentions of:
     - `deploy.sh` → `deploy-smart.sh`
     - `prepare-green.sh` → `prepare-green-smart.sh`
   - Examples to update:
     - “Retry deployment”: `./scripts/blue-green/deploy-smart.sh crypto-ai-agent`
     - “Kill stuck deployment / retry”: same adjustment.
     - “Always Test Before Production”: `./scripts/blue-green/prepare-green-smart.sh crypto-ai-agent`.

2. **`add-domain.sh` troubleshooting example**
   - Where it suggests:
     - `./scripts/add-domain.sh crypto-ai-agent.statex.cz`
   - Append a note or short paragraph:
     - Explain that `add-domain.sh` uses the validation system:
       - Writes to `staging/`, validates in isolation, moves to `blue-green/` on success, and to `rejected/` otherwise.
     - Emphasize:
       - “If this command fails due to a bad nginx config, nginx remains running with existing configs; inspect `nginx/conf.d/rejected/` and `logs/blue-green/deploy.log`.”

3. **Troubleshooting steps related to config regeneration**
   - In any step that suggests regenerating configs, reference:
     - `./scripts/blue-green/migrate-to-symlinks.sh` as the safe way to regenerate configs using the validation pipeline.
   - Ensure no step suggests manually editing `nginx/conf.d/*.conf` and reloading nginx directly.

---

## IMPLEMENTATION CHECKLIST

1. Open `docs/NGINX MICROSERVICE.md` and update the **Key Principles** list to include the validated nginx config pipeline and nginx-always-runs guarantee.
2. Rewrite the `nginx/` subsection in the **Project Structure** of `docs/NGINX MICROSERVICE.md` to show `conf.d/staging/`, `conf.d/blue-green/`, `conf.d/rejected/`, and `{domain}.conf` symlinks, plus both `domain.conf.template` and `domain-blue-green.conf.template`.
3. In `docs/NGINX MICROSERVICE.md`, replace the legacy “Add Domain Process” steps with the new validated flow (staging → validation → blue-green → symlink → safe reload) and explicitly document the safety guarantee.
4. Update the **Maintenance** section in `docs/NGINX MICROSERVICE.md` so all bullet points reference the validated pipeline and make clear that adding/removing domains cannot break a running nginx.
5. Optionally add a short **“Nginx Config Validation Workflow”** subsection to `docs/NGINX MICROSERVICE.md`, reusing the canonical description from `CONTAINER_NGINX_SYNC.md` (directory structure + validation steps + guarantees).
6. In `docs/BLUE_GREEN_DEPLOYMENT.md`, replace all references to `deploy.sh` with `deploy-smart.sh` and to `prepare-green.sh` with `prepare-green-smart.sh`.
7. Enhance the configuration generation / nginx configuration sections in `docs/BLUE_GREEN_DEPLOYMENT.md` to explicitly mention generation to `staging/`, isolated validation, promotion to `blue-green/`, and rejection to `rejected/`.
8. Update the “Standard Deployment Flow” in `docs/BLUE_GREEN_DEPLOYMENT.md` to note that nginx configs are created and applied via the validated staging → blue-green pipeline.
9. In the “Adding a New Service” section of `docs/BLUE_GREEN_DEPLOYMENT.md`, add a note that `migrate-to-symlinks.sh` uses the same validation pipeline and cannot break nginx.
10. In `docs/BLUE_GREEN_TROUBLESHOOTING.md`, replace all mentions of `deploy.sh` with `deploy-smart.sh` and of `prepare-green.sh` with `prepare-green-smart.sh`.
11. Augment the `add-domain.sh` troubleshooting example in `docs/BLUE_GREEN_TROUBLESHOOTING.md` with an explanation of the validation behavior (staging → validation → blue-green/rejected) and guidance to inspect `rejected/` and logs on failure.
12. Review all troubleshooting steps in `docs/BLUE_GREEN_TROUBLESHOOTING.md` to ensure none recommend manual edits to `nginx/conf.d/*.conf`; where needed, point to `migrate-to-symlinks.sh` or the sync/restart scripts instead.
13. After all documentation edits, re-read the three updated docs to confirm there are **no remaining references** to direct, unvalidated writes into `nginx/conf.d/*.conf` and that the validated workflow is consistently described everywhere.


